generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String        @id @default(uuid())
  first_name        String
  last_name         String
  phone             String
  email             String        @unique
  password          String
  company_name      String?
  image_url         String?
  profile_completed Boolean       @default(false)
  verified          Boolean       @default(false)
  type              UserType      @default(USER)
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
  packages          Package[]
  userCreatedPackages Package[]  @relation("UserCreatedPackages")
  dishes            Dish[]
  package_items     PackageItem[]
  catererinfo       catererinfo?
  cart              Cart?
  orders            Order[]
  proposals         Proposal[]
  catererProposals  Proposal[]    @relation("CatererProposals")
}

model catererinfo {
  id                   String   @id @default(uuid())
  business_name        String
  business_type        String
  business_description String?
  service_area         String?
  minimum_guests       Int?
  maximum_guests       Int?
  region               String?
  delivery_only        Boolean  @default(true)
  delivery_plus_setup  Boolean  @default(true)
  full_service         Boolean  @default(true)
  staff                Int?
  servers              Int?
  preparation_time     Int?
  food_license         String?
  Registration         String?
  caterer_id           String   @unique
  status               Status   @default(PENDING)
  caterer              User     @relation(fields: [caterer_id], references: [id], onDelete: Cascade)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt
}

enum Status {
  PENDING
  APPROVED
  REJECTED
  BLOCKED
}

model CuisineType {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  dishes      Dish[]
}

model Category {
  id                 String                     @id @default(uuid())
  name               String                     @unique
  description        String?
  created_at         DateTime                   @default(now())
  updated_at         DateTime                   @updatedAt
  dishes             Dish[]
  package_selections PackageCategorySelection[]
  subCategories      SubCategory[]
}

model SubCategory {
  id          String   @id @default(uuid())
  name        String
  description String?
  category_id String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  dishes      Dish[]
  category    Category @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@unique([name, category_id])
  @@index([category_id])
}

model FreeForm {
  id          String         @id @default(uuid())
  name        String         @unique
  description String?
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt
  dishes      DishFreeForm[]
}

model DishFreeForm {
  id          String   @id @default(uuid())
  dish_id     String
  freeform_id String
  created_at  DateTime @default(now())
  dish        Dish     @relation(fields: [dish_id], references: [id], onDelete: Cascade)
  freeform    FreeForm @relation(fields: [freeform_id], references: [id], onDelete: Cascade)

  @@unique([dish_id, freeform_id])
  @@index([dish_id])
  @@index([freeform_id])
}

model Dish {
  id              String         @id @default(uuid())
  name            String
  image_url       String?
  cuisine_type_id String
  category_id     String
  sub_category_id String?
  caterer_id      String?
  quantity_in_gm  Int?
  pieces          Int            @default(1)
  price           Decimal        @db.Decimal(10, 2)
  currency        String         @default("AED")
  is_active       Boolean        @default(true)
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt
  category        Category       @relation(fields: [category_id], references: [id])
  cuisine_type    CuisineType    @relation(fields: [cuisine_type_id], references: [id])
  sub_category    SubCategory?   @relation(fields: [sub_category_id], references: [id])
  caterer         User?          @relation(fields: [caterer_id], references: [id], onDelete: Cascade)
  free_forms      DishFreeForm[]
  package_items   PackageItem[]

  @@index([cuisine_type_id])
  @@index([category_id])
  @@index([sub_category_id])
  @@index([caterer_id])
  @@index([is_active])
}

model PackageType {
  id          String      @id @default(uuid())
  name        String      @unique
  image_url   String?
  description String?
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  packages    Package[]
  cart_items  CartItem[]
  order_items OrderItem[]
}

model Occassion {
  id          String             @id @default(uuid())
  name        String             @unique
  image_url   String?
  description String?
  created_at  DateTime           @default(now())
  updated_at  DateTime           @updatedAt
  packages    PackageOccassion[]
}

model PackageOccassion {
  id          String    @id @default(uuid())
  package_id  String
  occasion_id String
  created_at  DateTime  @default(now())
  occassion   Occassion @relation(fields: [occasion_id], references: [id], onDelete: Cascade)
  package     Package   @relation(fields: [package_id], references: [id], onDelete: Cascade)

  @@unique([package_id, occasion_id])
  @@index([package_id])
  @@index([occasion_id])
}

model Package {
  id                  String                     @id @default(uuid())
  name                String
  description         String?                    @db.Text // Package description
  people_count        Int
  package_type_id     String
  cover_image_url     String?
  total_price         Decimal                    @db.Decimal(10, 2)
  currency            String                     @default("AED")
  rating              Float?
  is_active           Boolean                    @default(true)
  is_available        Boolean                    @default(true)
  caterer_id          String
  user_id             String?                    // ID of the user who created this package (for USER-created packages)
  created_by          CreatedBy                  @default(CATERER)
  customisation_type  CustomisationType          @default(FIXED)
  additional_info     String?                    @db.Text // Extra pricing and services information
  created_at          DateTime                   @default(now())
  updated_at          DateTime                   @updatedAt
  caterer             User                       @relation(fields: [caterer_id], references: [id], onDelete: Cascade)
  created_by_user     User?                      @relation("UserCreatedPackages", fields: [user_id], references: [id], onDelete: SetNull)
  package_type        PackageType                @relation(fields: [package_type_id], references: [id])
  category_selections PackageCategorySelection[]
  items               PackageItem[]
  occasions           PackageOccassion[]
  cart_items          CartItem[]
  order_items         OrderItem[]


  @@index([package_type_id])
  @@index([caterer_id])
  @@index([user_id])
  @@index([is_active])
  @@index([is_available])
}

model PackageItem {
  id            String   @id @default(uuid())
  package_id    String? // Made nullable so items can exist without a package
  caterer_id    String?
  dish_id       String
  people_count  Int
  is_optional   Boolean  @default(false)
  quantity      Int      @default(1)
  price_at_time Decimal? @db.Decimal(10, 2)
  is_addon      Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  caterer       User?    @relation(fields: [caterer_id], references: [id], onDelete: Cascade)
  dish          Dish     @relation(fields: [dish_id], references: [id])
  package       Package? @relation(fields: [package_id], references: [id], onDelete: Cascade)

  @@index([package_id])
  @@index([dish_id])
  @@index([is_addon])
}

model PackageCategorySelection {
  id                   String   @id @default(uuid())
  package_id           String
  category_id          String
  num_dishes_to_select Int?     // null = select all, number = select exactly that many
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt
  category             Category @relation(fields: [category_id], references: [id])
  package              Package  @relation(fields: [package_id], references: [id], onDelete: Cascade)

  @@unique([package_id, category_id])
  @@index([package_id])
  @@index([category_id])
}

enum UserType {
  USER
  ADMIN
  CATERER
}

model Cart {
  id         String     @id @default(uuid())
  user_id    String     @unique
  user       User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  items      CartItem[]
  created_at DateTime   @default(now())
  updated_at DateTime   @updatedAt
}

model CartItem {
  id              String      @id @default(uuid())
  cart_id         String
  package_id      String
  package_type_id String
  location        String?
  guests          Int?
  date            DateTime?
  price_at_time   Decimal?    @db.Decimal(10, 2)
  cart            Cart        @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  package         Package     @relation(fields: [package_id], references: [id])
  package_type    PackageType @relation(fields: [package_type_id], references: [id])
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt

  @@unique([cart_id, package_id]) // same package once per cart
  @@index([cart_id])
  @@index([package_id])
  @@index([package_type_id])
}

model Order {
  id          String      @id @default(uuid())
  user_id     String
  user        User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  total_price Decimal     @db.Decimal(10, 2)
  currency    String      @default("AED")
  status      OrderStatus @default(PENDING)
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  items       OrderItem[]

  @@index([user_id])
  @@index([status])
}

model OrderItem {
  id              String      @id @default(uuid())
  order_id        String
  package_id      String
  package_type_id String
  location        String?
  guests          Int?
  date            DateTime?
  price_at_time   Decimal     @db.Decimal(10, 2)
  order           Order       @relation(fields: [order_id], references: [id], onDelete: Cascade)
  package         Package     @relation(fields: [package_id], references: [id], onDelete: Restrict)
  package_type    PackageType @relation(fields: [package_type_id], references: [id])
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt

  @@index([order_id])
  @@index([package_id])
  @@index([package_type_id])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PAID
  PREPARING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

model Proposal {
  id                  String         @id @default(uuid())
  user_id             String
  caterer_id          String
  status              ProposalStatus @default(PENDING)
  event_type          String?
  location            String?
  dietary_preferences String[]       @default([]) // Array of dietary preference strings
  budget_per_person   Decimal?       @db.Decimal(10, 2)
  event_date          DateTime?
  vision              String?        @db.Text
  guest_count         Int
  created_at          DateTime       @default(now())
  updated_at          DateTime       @updatedAt
  user                User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  caterer             User           @relation("CatererProposals", fields: [caterer_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([caterer_id])
  @@index([status])
  @@index([created_at])
}

enum ProposalStatus {
  PENDING // Initial status when proposal is created
  PROCESSING // Caterer is reviewing/processing the proposal
  QUOTED // Caterer has provided a quote
  ACCEPTED // User has accepted the quote
  REJECTED // Caterer rejected the proposal
  CANCELLED // User cancelled the proposal
  EXPIRED // Proposal expired (e.g., event date passed)
}

enum CreatedBy {
  USER
  CATERER
}

enum CustomisationType {
  FIXED
  CUSTOMISABLE
}
